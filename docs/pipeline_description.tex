\documentclass[a4paper,11pt,oneside]{amsart}
\usepackage[hidelinks]{hyperref}
\usepackage{microtype}
\usepackage{phlotgschola}
\usepackage{amsfonts,amsmath,mathtools,url}
\usepackage{xcolor,graphicx,framed,verbatim}
\usepackage[a4paper,top=1in,bottom=1in,left=1.5in,right=1.5in]{geometry}
\usepackage[style=nature,doi=false,isbn=false,url=false,hyperref=true,date=year,backend=biber]{biblatex}
\addbibresource{pipeline_description.bib}

% Configure framed package use for code blocks
\colorlet{shadecolor}{lightgray}
\setlength{\OuterFrameSep}{0.2\baselineskip}
\setlength{\FrameSep}{0.2\baselineskip}

% Environments for shell and R code
\newenvironment{code}%
   {\bgroup\topsep=0.2ex\partopsep=0.2ex\shaded\verbatim}%
   {\endverbatim\endshaded\egroup}
\newenvironment{codebox}%
   {\bgroup\topsep=0.2ex\partopsep=0.2ex\shaded\noindent}%
   {\endshaded\egroup}

% biblatex-nature writes the title of unpublished works in italic by default,
% and uses typewrite for urls. We want to use the normal font in both cases,
% but we still need to use the url package to allow line breaks within the url,
% and we while we're at it, we use the hyperref package to make it clickable.
\makeatletter
\DeclareRobustCommand*{\preprinturl}{%
  \hyper@normalise\preprinturl@
}
\newcommand*{\preprinturl@}[1]{%
  \hyper@linkurl{\preprinturl@@{#1}}{#1}%
}
\DeclareUrlCommand\preprinturl@@{\urlstyle{same}}
\makeatother
\DeclareFieldFormat[unpublished]{title}{#1}
\DeclareFieldFormat{url}{\preprinturl{#1}}

% Write "Preprint at URL"
\newbibmacro*{preprint+url}{%
  \printtext{Preprint at}%
  \addspace%
  \printfield{url}%
}

% By default, biblatex-nature does not seem to correctly handle @unpublished
% entries (i.e. preprints) correctly.
\DeclareBibliographyDriver{unpublished}{%
  \usebibmacro{bibindex}%
  \usebibmacro{begentry}%
  \usebibmacro{author/translator+others}%Smith2017
  \setunit{\labelnamepunct}\newblock
  \iftoggle{bbx:articletitle}
    {%
      \usebibmacro{title}%
      \newblock
    }
    {}%
  \printlist{language}%
  \newunit\newblock
  \usebibmacro{byauthor}%
  \newunit\newblock
  \usebibmacro{bytranslator+others}%
  \newunit\newblock
  \printfield{version}%
  \newunit\newblock
  \usebibmacro{note+pages}%
  \newunit\newblock
  \usebibmacro{preprint+url}%
  \newunit\newblock
  \usebibmacro{issue+date}%
  \newunit\newblock
  \usebibmacro{addendum+pubstate}%
  \setunit{\bibpagerefpunct}\newblock
  \usebibmacro{pageref}%
  \newunit\newblock
  \usebibmacro{related}%
  \usebibmacro{finentry}%
}

% References
\defbibheading{references}{%
  \section*{References}%
%  \addcontentsline{toc}{section}{References}%
}

% Footnotes use letters
\renewcommand{\thefootnote}{\alph{footnote}}

% Title and subtitle
\DeclareRobustCommand{\titletext}[1]{#1\\}
\DeclareRobustCommand{\captiontext}[1]{#1}
\title{\titletext{S1 Supporting Methods:}\captiontext{iPool-Seq Analysis Pipeline Description}}
%\date{\today}

% Tweak layoyt
\sloppy
\lineskiplimit=-2pt
\lineskip=2pt

\begin{document}

\maketitle
\DeclareRobustCommand{\titletext}[1]{}

\section{Read validation \& mapping}

\subsection*{Demultiplexing}

The 12 libraries (one input and one output library for each of three replicates in experiments A \& B) were sequenced (paired-end, 75 bp reads from both fragment ends) on two Illumina MiSeq flowcells (one per experiment). The runs were demultiplexed using \textit{deML}\cite{Renaud2015} (pre-release, commit 80a491), and separate BAM files for each library are available in the \emph{european nucleotide archive} (ENA), accession PRJEB23309.

\subsection*{Read-through removal}

Read-throughs into the sequencing adapter on the other end (for short fragments) were removed using \textit{Trimmomatic}\cite{Bolger2014}  (version 0.33) in \texttt{PE} (paired-end) mode using commands \texttt{ILLUMINACLIP:\allowbreak adpaters.fa:\allowbreak 2:\allowbreak 24:\allowbreak 15:\allowbreak 1:\allowbreak true} and \texttt{MINLEN:\allowbreak 40}, with \texttt{adapters.fa} containing the following two sequencing adapters:
\begin{code}
>PrefixPE/1
CACGACGCTCTTCCGATCT
>PrefixPE/2
GTGACTGGAGTTCAGACGTGTGCTCTTCCGATCT
\end{code}

\subsection*{UMI extraction \& technical sequence removal (\texttt{trim.tag.py})}

From the construction of the 195 (single-gene) insertional mutants of \textit{U. maydis} and the library preparation protocol used, we expected the double-stranded fragments subjected to sequencing to have the following layout (both strands shown):

\vspace{\baselineskip}
\noindent\begin{minipage}{\textwidth}
\newcommand{\vp}{\vphantom{\langle\rangle\big(\big){^\texttt{ACGTN}_\texttt{ACGTN}}}}
\vbox{%
  \hbox to \textwidth{$\xrightarrow[\hspace{9cm}]{\text{read 1 (top strand)}}$}
  \hbox to \textwidth{%
    \llap{$\mathsurround=0pt{^\text{5'}_\text{3'}}\Big|\ $}$%
    \underbrace{\vp\langle\textit{Filler}\rangle}_{\text{0 or 1 bp}}\quad%
    \underbrace{\vp\langle\textit{UMI}\rangle}_{\text{12 bp}}\quad%
    \underbrace{\vp{^\texttt{AGATGTGTATAAGAGACAG}
                    _\texttt{TCTACACATATTCTCTGTC}}}
              _{\substack{\text{19 bp}\\\text{Mosaic End (ME)}}}\quad%
    $\dotfill\hspace{2cm}
  }
}
\vbox{%
  \hbox to \textwidth{%
    \hspace{2cm}
    \dotfill$\quad
    \overbrace{\vp\big({^{\texttt{GAT}}
                         _{\texttt{CTA}}}
                \ \ \textit{or}\ \ 
                        {^\texttt{GCCACTCA}
                         _\texttt{CGGTGAGT}}
                \big)}
             ^{\text{3 or 8 bp}}\quad%
    \overbrace{\vp{^\texttt{CGCCACAGGATACCACAG}
                    _\texttt{GCGGTGTCCTATGGTGTC}}}
             ^{\text{18 bp}}\quad%
    \overbrace{\vp\langle\textit{Filler}\rangle}
             ^{\text{0 or 1 bp}}%
    \rlap{$\mathsurround=0pt\ \Big|{^\text{3'}_\text{5'}}$}
  $}
  \hbox to \textwidth{\hfill$\xleftarrow[\text{read 2 (bottom strand)}]{\hspace{9cm}}$}
}
\end{minipage}
\vspace{\baselineskip}

The part denoted ``\ldots'' is a genomic \textit{U. maydis} sequence, more specifically a sequence from the 3' or 5' flank of one the 195 studied genes. Our custom script \texttt{trim.tag.py} matched the sequenced read pairs against this expected pattern, allowing up to 4 mismatches (not counting \texttt{N}s) within the fixed part of each mate. Our script then stored the UMIs as part of the read names, and stripped all technical sequences (i.e. everything except the ``\ldots'' part) from the reads. If the two mates of a pair overlapped (i.e. for fragments shorter than $2\cdot 75=150$ bp), a technical sequence from one mate possibly appeared reverse-completed on the other mate as well. We detected this by checking whether a gap-less ends-free alignment of the two reads had an identity $\geq 90\%$, and then used the alignment to locate and remove the corresponding part of the complementary mate as well.

\subsection*{Assignment to mutants (\texttt{assign\_to\_features.py})}

To assign the reads to genes (and hence to insertional mutants), we mapped the paired-end reads (after UMI extraction and technical sequence removal) to the \textit{U. maydis} genome, \textit{GeneBank} accession GCF\_000328475.2\cite{Kamper2006}, using \textit{NextGenMap}\cite{Sedlazeck2013} (version v0.4.13) with parameters 
\texttt{-{}-end-\allowbreak to-\allowbreak end} \texttt{-{}-pair-\allowbreak score-\allowbreak cutoff 0.5} \texttt{-{}-sensitivity 0.3} \texttt{-{}-kmer 13} \texttt{-{}-kmer-\allowbreak skip 0}.

Proper read pairs (read pairs where one mate maps in the forward direction, the other in the reverse direction, and the mates point ``towards'' one another) were assigned to a particular gene if either mate's first sequenced base mapped to within $\pm 10$ bp of one of the genes flanks, and the rest of that read continued ``away'' from the gene.

Improper read pairs (non-proper read pairs where nevertheless both mates were mapped) were ignored.

Singleton reads (i.e. reads whose mate could not be mapped) were assigned to a particular gene if their first sequenced base mapped to within a 1000 bp window on either side of the gene and they continued ``towards'' the gene.

Read pairs assigned to no or multiple genes were ignored.

\section{UMI analysis \& abundance estimation}

\subsection*{Correcting UMIs for sequencing errors (\texttt{umicounts.tag.py})}

To count \textit{U. maydis} insertional mutant genomes (i.e. cells), we counted the number of (sufficiently distinct, to protect against sequencing errors) combinations of UMI and mapping position within the reads mapping to a particular flank (3' or 5') of a particular gene. For the sake of brevity, \textit{UMI} in the following denotes a \emph{combination} of a particular 12 bp molecular barcode (so far called UMI) and the two mate's mapping positions.

To merge similar UMIs (which likely stem from the same cell), we used a variation of the algorithm of Smith \textit{et al.}\cite{Smith2016}. We started with the raw list of unique UMIs. We then marked an UMI $p$ as \emph{mergeable} into UMI $q$ if the molecular barcodes disagreed at most at a single position, the mapping positions by no more than $\pm 3$ bases, and $p$ was found in fewer reads than $q$. The UMIs not marked as mergeable were then assumed to be error-free. The read counts of UMIs that were mergeable (directly or indirectly) with a single error-free UMI were added to the error-free UMI's read count. UMIs marked (directly or indirectly) as mergeable with multiple error-free candidates were discarded as being ambiguous.

This produced, for both flanks of every gene, a separate list of assumedly error-free UMIs and per-UMI read counts.

\subsection*{Correcting for artifacts and lost UMIs to estimate abundance (\texttt{counts2results.R}) }

We then further processed the per-flank UMIs using the algorithm of Pflug \& von Haeseler\cite{Pflug2017Preprint}, i.e. we removed all UMIs with a read count below a manually set read-count threshold ($T=1$, except $T=5$ for Experiment B R1 \& R2 Output, and $T=9$ for Experiment B R3 Output), and then estimated (for both flanks of every gene separately) the percentage $\ell$ of UMIs lost during sequencing and data filtering. 

This yielded, separately for both flanks of every gene, a number $n^\text{obs}$ of observed UMIs (after all filtering steps) and a loss estimate $\ell$. Given these two, a (flank-specific) estimate of true mutant abundance is $n^\text{obs} / (1-\ell)$.

\section{Statistical Analysis}

\subsection*{Modelling growth of neutral mutants (\texttt{model.R})}

Given an insertional mutant $m$'s \emph{true} (unknown) abundances $A^\text{in}_{m}$ and $A^\text{out}_{m}$ in a particular pair of input and output libraries, and given the respective losses (i.e. fraction of unobserved or filtered UMIs) $\ell^\text{in}_{mf}$ and $\ell^\text{out}_{mf}$ for flank $f$ (3' or 5'), we assumed that the observed number of per-flank UMIs (after filtering) is Poisson distributed with mean $A^\text{in}_{m}\cdot(1-\ell^\text{in}_{mf})$ respectively $A^\text{out}_{m}\cdot(1-\ell^\text{out}_{mf})$.  For the \emph{sum} $N^\text{in}_m$ respectively $N^\text{out}_m$ of UMIs on the two flanks (5' and 3') of the mutamt $m$ in the input respectively output library, it follows that
\begin{align}\label{eq-model}
  N^\text{in}_m\;\big|\;A^\text{in}_{m} &\sim \text{Poisson}\left(A^\text{in}_{m}\cdot(1-\bar\ell^\text{in}_m)\right), &
  N^\text{out}_m\;\big|\;A^\text{out}_{m} &\sim \text{Poisson}\left(A^\text{out}_{m}\cdot(1-\bar\ell^\text{out}_m)\right) \\
  \text{where}\quad
  \bar\ell^\text{in}_m &= \ell^\text{in}_{m,5'} + \ell^\text{in}_{m,3'}, &
  \bar\ell^\text{out}_m &= \ell^\text{out}_{m,5'} + \ell^\text{out}_{m,3'}. \nonumber
\end{align} 

We then further assumed that for neutral mutants the \emph{expected} true input and output abundances are proportional (with the same factor $\lambda$ for all neutral mutants in a particular pair of input and output libraries), but that the output abundances have additional dispersion $d$ due to random fluctuations of mutant growth, i.e. that
\begin{align}\label{eq-a_out}
  \mathbb{E}\, A^\text{out}_m &= \lambda\cdot \mathbb{E}\, A^\text{in}_m, &
  \mathbb{V}\, A^\text{out}_m &= \lambda^2\cdot \mathbb{V}\, A^\text{in}_m + d\cdot\left(\mathbb{E}\, A^\text{out}_m\right)^2.&
\end{align}

To find the \emph{null distribution} (i.e. assuming mutant $m$ is neutral) for the output UMI count $N^\text{out}_m$ given observed input count $n^\text{in}_m$, we computed the posterior $A^\text{in}_{m}\;|\;N^\text{in}_m$ (using degenerate prior $\text{Gamma}(0,0)$), added dispersion $d$ to get $A^\text{out}_{m}\;|\;N^\text{in}_m$, and combined with $N^\text{out}_m\;\big|\;A^\text{out}_{m}$. The resulting \emph{negative binomial} distribution depends on two mutant-independent parameters, proportionality factor $\lambda$ and dispersion $d$,
\begin{equation}\label{eq-n_out-dist}
  N^\text{out}_m\;\big|\;n^\text{in}_{m} \sim
  \text{NegBin}\left(\mu_m := \lambda\cdot n^\text{in}_{m}\cdot\tfrac{1-\bar\ell^\text{out}_m}{1-\bar\ell^\text{in}_m},\;
                     r_m := \frac{n^\text{in}_{m}}{1 + d\cdot n^\text{in}_{m}}\right).
\end{equation}

\subsection*{Computing p-values, q-values and effect sizes (\texttt{r4896.Rmd}, \texttt{r5157.Rmd})}

For each of the 6 pairs of input and output libraries, we estimated $\lambda$ and $d$ by maximizing the likelihood of the negative binomial model (\ref{eq-n_out-dist}) over a reference set of neutral mutants (see below for how those were selected). Given $\lambda$ and $d$, we then computed (one-sided) p-values $p^\text{low}_m$ (sig. of depletion in output) and $p^\text{high}_m$ (sig. enrichment in output), for each mutant $m$ detected in both output and input, as
\begin{equation}
  p^\text{low}_m = \mathbb{P}\left(N^\text{out}_m \leq n^\text{out}_m\right), \quad
  p^\text{high}_m = \mathbb{P}\left(N^\text{out}_m \geq n^\text{out}_m\right)
  \quad\text{if}\ n^\text{in}_m,\,n^\text{out}_m \geq 1.
\end{equation}

To control the \emph{false discovery rate} (FDR), we applied the Benjamini-Hochberg (BH) procedure\cite{Benjamini1995} (separately) to the collection of low and high p-values computed for a particular pair of input and output libraries, and set the FDR target to 10\%.

To quantify the effect size, we also computed the $\log_2$ fold change ($\text{lfc}_m$) between each mutant $m$'s observed output UMI count and the expected value for neutral mutants,
\begin{equation}
  \text{lfc}_m = \log_2 \frac{n^\text{out}_m\cdot(1-\bar\ell^\text{in}_m)}{\lambda\cdot n^\text{in}_m\cdot(1-\bar\ell^\text{out}_m)}.
\end{equation}

\subsection*{Selecting the neutral reference set}

We started with a candidate list of 13 insertional mutants described as neutral in the literature (UMAG\_01297, UMAG\_01300, UMAG\_01302, UMAG\_02192, UMAG\_02193, UMAG\_03046, UMAG\_03201, UMAG\_03202, UMAG\_03615, UMAG\_06222, UMAG\_10403, UMAG\_10553, UMAG\_12313), estimated $\lambda$ and $d$ for all 6 input-output pairs, and computed these mutants' $\log_2$ fold changes. Suspecting that not all of these mutants are truly neutral, we looked for outliers (defined as for boxplots in R, values more than 1.5 IQR larger/smaller than the 75\%/25\% quantile) amongst these $\log_2$ fold changes and discarded them. We repeated this procedure for the remaining 8 candidates (UMAG\_01302, UMAG\_02192, UMAG\_02193, UMAG\_03046, UMAG\_03202, UMAG\_03615, UMAG\_10403, UMAG\_10553), and found 3 additional outliers. The remaining 5 candidate mutants (UMAG\_01302, UMAG\_02193, UMAG\_03202, UMAG\_10403, UMAG\_10553) were then used as the final neutral reference set, and all p-values, q-values and $\log_2$ fold changes were re-computed based on this set.

\subsection*{Sensitivity of a genome-wide screen}

To estimate the sensitivity of a genome-wide screen, we simulated experiments containing $m=20,000$ distinct mutants using the statistical model from equation (\ref{eq-model}), but assuming a negative binomial distribution for $N^\text{out}_m$ to account for the additional dispersion $d$ of the output abundances (see also equation \ref{eq-a_out}). We assumed the input abundances to be identical for all mutants (i.e $A^\text{in}_1=\ldots=A^\text{in}_{20.000}=A^\text{in}$), the output abundances of $k$ mutants to show a virulence phenotype and hence to be reduced $2^{-\rho}$-fold (i.e. $A^\text{out}_1=\ldots=A^\text{out}_k=A^\text{in}\cdot 2^{\rho}$), and the other $m-k$ mutants to be neutral ($A^\text{out}_{k+1}=\ldots=A^\text{out}_{20,000}=A^\text{in}$). Based on $\approx 14\%$ of mutants in our screen showing a reproducible phenotype, and supplemental table 5 of Lanver \textit{et al.} \cite{Lanver2018} showing $\approx 22\%$ of genes to be upregulated during infection, we set $k=20,000\cdot 0.14\cdot0.22 =600$ (i.e. $\approx 3\%$ of mutants have a virulence phenotype). We set the additional dispersion $d$ to the highest value observed in our 6 experiments (0.0126), and simulated 100 experiments for each input abundance $A^\text{in}=1,2,\ldots,100$, once with log$_2$ fold change of $\rho=-1.53$ (corresponding to the ``Reduced'' group in figure 4a) and once with $\rho=-2.75$ (corresponding to the ``Lost virulence'' group). For each simulated experiment we computed q-values as described above (see \textit{Computing p-values, q-values and effect sizes}), determined the percentage of significant mutants within the ones with a virulence phenotype, and averaged these percentages over the 100 experiments to compute the efficiencies shown in figure S3.

\section{Running the pipeline}
\enlargethispage{1\baselineskip}

\subsection*{Required software in addition to cited}

\emph{GNU Bash} (4.2.53). \emph{GNU Make} (4.0). \emph{Picard} (1.141). \emph{samtools} (1.3.1). \emph{gzip} (1.6). \emph{python} (2.7.5). Python libraries: \emph{recordtype} (1.1), \emph{distance} (0.1.3), \emph{regex} (2016.4.15), \emph{pysam} (0.12.0.1), \emph{bcbio-gff} (0.6.2), \emph{biopython} (1.66). \emph{R} (3.2.1). R libraries: \emph{data.table} (1.10.4), \emph{parallel} (3.2.1), \emph{rmarkdown} (1.8). R Bioconductor Libraries: \emph{rtracklayer} (1.30.4). Other R libraries: \emph{gwpcR}\footnote{\url{http://github.com/Cibiv/gwpcR}, see also Pflug \& von Haeseler\cite{Pflug2017Preprint}} (0.9.9).

\subsection*{Running ``abundance estimation'' (incl. prerequisite steps)}

The pipeline (see S1 Software \textit{iPool-Seq Analysis Pipeline}) uses separate subdirectories under \texttt{data/} for each library, e.g. \texttt{data/r4896.in1} for the input library of replicate 1 of experiment A. These directories contains various file controlling the pipeline (\texttt{tom.cfg}, \texttt{ngm.cfg}, \texttt{ref.fasta}, \texttt{features.gff}, \texttt{ngm.results.cfg}). To repeat our analyses, download the BAM files belonging to 12 libraries from \url{ftp://ftp.sra.ebi.ac.uk/vol1/ERA112/ERA1125781/bam/}, and store the file named \texttt{r}\textit{<experiment\_id>}/\textit{<library>.bam} as \texttt{data/r}\textit{<experiment\_id>}\texttt{.}\textit{<library>}\texttt{/raw.bam}.

The pipeline produces for each library two R data files as output, \texttt{ngm.results.rda} and \texttt{ngm.stats.rda}. For each subdirectory of \texttt{data/} run:

\begin{codebox}\noindent
\texttt{make}
  \texttt{data/}\textit{<subdir>}\texttt{/ngm.results.rda}
  \texttt{data/}\textit{<subdir>}\texttt{/ngm.stats.rda}
\end{codebox}

\subsection*{Running ``Statistical Analysis''}

The pipeline contains two R notebooks, \texttt{r4896.Rmd} (experiment A) and \texttt{r5157.Rmd} (experiment B). In R, run them with:
\begin{codebox}\noindent
\texttt{library(rmarkdown)}\\
\texttt{render("}\textit{<experiment\_id>}\texttt{.Rmd", output\_format="pdf\_document")}
\end{codebox}

This produces a PDF report (\texttt{r}\textit{<experiment\_id>}\texttt{.pdf}) and table (\texttt{r}\textit{<experiment\_id>}\texttt{.abundance.csv}) listing for each mutant the raw and loss corrected input and output abundances, p- and q-values for significant depletion and enrichment, and the $\log_2$ fold change. It also produces two tables summarizing the significantly depleted (\texttt{r}\textit{<experiment\_id>}\texttt{.low.csv}) respectively enriched (\texttt{r}\textit{<experiment\_id>}\texttt{.high.csv}) mutants, and a R data file (\texttt{r}\textit{<experiment\_id>}\texttt{.model.rda}) containing the parameters of the null distributions.


\printbibliography[heading=references]

\end{document}
